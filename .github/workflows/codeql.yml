# CodeQL Security Analysis Workflow
# ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… CodeQL

name: "CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master", "develop" ]
  schedule:
    # ÙŠØªÙ… Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ø§Ù„Ø³Ø§Ø¹Ø© 6:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª UTC
    # Weekly scan every Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    # ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹ / Can be triggered manually

jobs:
  analyze:
    name: Analyze Code Security
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    permissions:
      # Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¬Ù…ÙŠØ¹ Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„
      # Required for all workflows
      security-events: write
      # Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø· Ù„Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
      # Required only for workflows in private repositories
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # CodeQL ÙŠØ¯Ø¹Ù…: 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'swift'
        # Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙŠØ³ØªØ®Ø¯Ù… Python ÙÙ‚Ø·
        # CodeQL supports multiple languages, this project uses Python only
        language: [ 'python' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # ØªÙ‡ÙŠØ¦Ø© CodeQL
    # Initialize CodeQL
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ù…Ø§Ù†
        # Additional security queries
        queries: +security-and-quality
        # ØªÙƒÙˆÙŠÙ† Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        # Custom configuration (optional)
        # config-file: ./.github/codeql/codeql-config.yml

    # Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù„Ù„ØºØ§Øª Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø© ÙÙ‚Ø·ØŒ Python Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¨Ù†Ø§Ø¡)
    # Build the application (for compiled languages only, Python doesn't need building)
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    # Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ CodeQL
    # Perform CodeQL analysis
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        # Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ GitHub Security
        # Upload results to GitHub Security
        upload: true
        # Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª CodeQL Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        # Save CodeQL database for local analysis (optional)
        # output: sarif-results
        # retention-days: 5

    # Ø®Ø·ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ù…Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    # Additional security steps (optional)
    - name: Check for secrets (if enabled)
      if: github.event_name == 'push'
      run: |
        echo "Checking for accidentally committed secrets..."
        # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆØ§Øª ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§
        # Additional scanning tools can be added here

    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    # Send notification on failure (optional)
    - name: Notify on failure
      if: failure()
      run: |
        echo "::warning::CodeQL analysis failed. Please check the security alerts."
        echo "ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ÙØ­Øµ CodeQL. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†."

  # ÙˆØ¸ÙŠÙØ© Ø¥Ø¶Ø§ÙÙŠØ©: ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
  # Additional job: Dependency vulnerability scanning
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Safety
      run: |
        python -m pip install --upgrade pip
        pip install safety

    - name: Run Safety check
      run: |
        echo "Checking for vulnerable dependencies..."
        echo "ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª..."
        pip install -r requirements.txt
        safety check --json || true
      continue-on-error: true

    - name: Summary
      run: |
        echo "### Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… CodeQL analysis completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Dependency check completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Check the **Security** tab for detailed results" >> $GITHUB_STEP_SUMMARY
        echo "ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ **Security** Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©" >> $GITHUB_STEP_SUMMARY
