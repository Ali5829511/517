# دليل API لإدارة السكان

## نظرة عامة
تم إضافة مجموعة كاملة من نقاط النهاية (API Endpoints) لإدارة دورة حياة السكان في نظام الإسكان الجامعي.

## نقاط النهاية المتاحة

### 1. الحصول على جميع السكان
```
GET /api/residents
```
**الصلاحيات:** مستخدم مسجل دخول  
**الاستجابة:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "محمد أحمد",
      "nationalId": "1234567890",
      "phone": "0501234567",
      "email": "mohammed@example.com",
      "building": "عمارة 10",
      "unit": "10",
      "unitType": "شقة 3 غرف",
      "moveInDate": "2025-01-15",
      "status": "نشط"
    }
  ]
}
```

---

### 2. إضافة ساكن جديد
```
POST /api/residents
```
**الصلاحيات:** مدير فقط  
**البيانات المطلوبة:**
```json
{
  "name": "اسم الساكن",
  "national_id": "1234567890",
  "phone": "0501234567",
  "email": "example@email.com",
  "unit_id": 123,
  "move_in_date": "2025-10-29",
  "status": "نشط"
}
```
**الاستجابة:**
```json
{
  "success": true,
  "id": 1058,
  "message": "تم إضافة الساكن بنجاح"
}
```

**ملاحظات:**
- الرقم الوطني يجب أن يكون فريداً
- عند إضافة ساكن، يتم تحديث حالة الوحدة تلقائياً إلى "مشغول"

---

### 3. تحديث معلومات ساكن
```
PUT /api/residents/{resident_id}
```
**الصلاحيات:** مدير فقط  
**البيانات المطلوبة:**
```json
{
  "name": "الاسم الجديد",
  "phone": "0509876543",
  "email": "newemail@example.com",
  "unit_id": 456,
  "status": "نشط"
}
```
**الاستجابة:**
```json
{
  "success": true,
  "message": "تم تحديث معلومات الساكن بنجاح"
}
```

**ملاحظات:**
- إذا تم تغيير الوحدة (unit_id)، يتم تحديث حالة الوحدة القديمة إلى "شاغر" والجديدة إلى "مشغول"
- لا يمكن تحديث الرقم الوطني

---

### 4. إخراج ساكن (سحب)
```
POST /api/residents/{resident_id}/checkout
```
**الصلاحيات:** مدير فقط  
**البيانات الاختيارية:**
```json
{
  "notes": "ملاحظات إضافية عن الإخراج"
}
```
**الاستجابة:**
```json
{
  "success": true,
  "message": "تم إخراج الساكن بنجاح"
}
```

**ما يحدث عند الإخراج:**
1. تحديث حالة الساكن إلى "مغادر"
2. إزالة ارتباط الساكن بالوحدة (unit_id = NULL)
3. تحديث حالة الوحدة إلى "شاغر"
4. إلغاء جميع ملصقات السيارات المرتبطة بالساكن (status = "ملغي")

---

### 5. حذف ساكن
```
DELETE /api/residents/{resident_id}
```
**الصلاحيات:** مدير فقط  
**الاستجابة:**
```json
{
  "success": true,
  "message": "تم حذف الساكن بنجاح"
}
```

**ملاحظات:**
- يتم حذف السجل نهائياً من قاعدة البيانات
- تحرير الوحدة المرتبطة (إن وجدت)
- **تحذير:** لا يمكن التراجع عن هذا الإجراء!

---

### 6. الحصول على الوحدات الشاغرة
```
GET /api/units/available?building_id={building_id}
```
**الصلاحيات:** مستخدم مسجل دخول  
**المعاملات:**
- `building_id` (اختياري): فلترة حسب رقم المبنى

**الاستجابة:**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "unitNumber": "10",
      "unitType": "شقة 3 غرف",
      "status": "شاغر",
      "buildingNumber": "عمارة 10"
    }
  ]
}
```

---

## أمثلة الاستخدام

### مثال 1: إضافة ساكن جديد
```bash
curl -X POST http://localhost:5000/api/residents \
  -H "Content-Type: application/json" \
  -d '{
    "name": "علي محمد",
    "national_id": "1234567890",
    "phone": "0501234567",
    "email": "ali@example.com",
    "unit_id": 123,
    "move_in_date": "2025-10-29",
    "status": "نشط"
  }'
```

### مثال 2: إخراج ساكن
```bash
curl -X POST http://localhost:5000/api/residents/1058/checkout \
  -H "Content-Type: application/json"
```

### مثال 3: الحصول على الوحدات الشاغرة في مبنى معين
```bash
curl -X GET "http://localhost:5000/api/units/available?building_id=5"
```

---

## رموز الحالة (Status Codes)

| الكود | المعنى |
|------|---------|
| 200 | نجح الطلب |
| 201 | تم الإنشاء بنجاح (عند إضافة ساكن) |
| 400 | خطأ في البيانات المرسلة |
| 401 | غير مصرح (يجب تسجيل الدخول) |
| 403 | ممنوع (صلاحيات غير كافية) |
| 500 | خطأ في الخادم |

---

## الأمان
- جميع عمليات التعديل (POST, PUT, DELETE) تتطلب صلاحيات المدير
- عمليات القراءة (GET) تتطلب تسجيل الدخول فقط
- يتم التحقق من صحة البيانات قبل حفظها
- الرقم الوطني يجب أن يكون فريداً

---

## الاختبار
لاختبار جميع الوظائف، قم بتشغيل:
```bash
python test_resident_management.py
```

هذا الاختبار يغطي:
- ✅ الحصول على الوحدات الشاغرة
- ✅ إضافة ساكن جديد
- ✅ تحديث معلومات ساكن
- ✅ إخراج ساكن
- ✅ حذف ساكن
