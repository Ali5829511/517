<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--card-color, #667eea), var(--card-color-light, #764ba2));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--card-color, #667eea), var(--card-color-light, #764ba2));
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-change {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }

        .stat-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .stat-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .data-table-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            width: 300px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            background: rgba(255,255,255,0.1);
        }

        .data-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tbody tr {
            transition: background 0.3s;
        }

        .data-table tbody tr:hover {
            background: #f5f5f5;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.active {
            background: #d4edda;
            color: #155724;
        }

        .badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.occupied {
            background: #fff3cd;
            color: #856404;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 25px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-size: 1.05em;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            position: relative;
            bottom: -12px;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-btn i {
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading i {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .search-box {
                width: 100%;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒØ§Ù† - Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³ÙƒØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</h3>
                <div class="chart-container">
                    <canvas id="buildingsChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3><i class="fas fa-chart-bar"></i> Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø´ØºØ§Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                <div class="chart-container">
                    <canvas id="occupancyChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3><i class="fas fa-chart-line"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ù</h3>
                <div class="chart-container">
                    <canvas id="parkingChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3><i class="fas fa-chart-area"></i> Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                <div class="chart-container">
                    <canvas id="stickersChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Tables with Tabs -->
        <div class="data-table-section">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('violations')"><i class="fas fa-car-crash"></i> Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©</button>
                <button class="tab-btn" onclick="switchTab('stickers')"><i class="fas fa-id-card"></i> Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
                <button class="tab-btn" onclick="switchTab('parking')"><i class="fas fa-parking"></i> Ø§Ù„Ù…ÙˆØ§Ù‚Ù</button>
            </div>
            
            <div class="table-controls">
                <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...">
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="exportToExcel()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px;">
                        <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
                    </button>
                    <button onclick="printTable()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px;">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button onclick="exportToPDF()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px;">
                        <i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF
                    </button>
                </div>
            </div>
            
            <div id="tableContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="loadAllData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script>
        let allResidents = [];
        let allBuildings = [];
        let allStickers = [];
        let allParking = [];
        let charts = {};
        let currentTab = 'violations'; // Default tab

        // Load all data
        async function loadAllData() {
            try {
                // Fetch all data in parallel
                const [residentsRes, buildingsRes, stickersRes, parkingRes] = await Promise.all([
                    fetch('/api/residents'),
                    fetch('/api/buildings'),
                    fetch('/api/stickers'),
                    fetch('/api/parking')
                ]);

                const residentsData = await residentsRes.json();
                const buildingsData = await buildingsRes.json();
                const stickersData = await stickersRes.json();
                const parkingData = await parkingRes.json();

                allResidents = residentsData.data || residentsData;
                allBuildings = buildingsData.data || buildingsData;
                allStickers = stickersData.data || stickersData;
                allParking = parkingData.data || parkingData;

                // Update UI
                updateStatistics();
                updateCharts();
                switchTab(currentTab); // Load current tab data
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        // Update statistics cards
        function updateStatistics() {
            const totalResidents = allResidents.length;
            const totalBuildings = allBuildings.length;
            const totalStickers = allStickers.length;
            const activeStickers = allStickers.filter(s => s.status === 'ÙØ¹Ø§Ù„' || s.status === 'active').length;
            const totalParking = allParking.length;
            const occupiedParking = allParking.filter(p => p.status === 'Ù…Ø´ØºÙˆÙ„' || p.status === 'occupied').length;
            const parkingUsage = totalParking > 0 ? Math.round((occupiedParking / totalParking) * 100) : 0;

            const stats = [
                {
                    icon: 'fa-users',
                    value: totalResidents.toLocaleString('ar-SA'),
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙƒØ§Ù†',
                    color: '#667eea',
                    colorLight: '#764ba2',
                    change: '+5.2%',
                    positive: true
                },
                {
                    icon: 'fa-building',
                    value: totalBuildings,
                    label: 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©',
                    color: '#f093fb',
                    colorLight: '#f5576c',
                    change: '+2.1%',
                    positive: true
                },
                {
                    icon: 'fa-id-card',
                    value: activeStickers.toLocaleString('ar-SA'),
                    label: 'Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©',
                    color: '#4facfe',
                    colorLight: '#00f2fe',
                    change: '+8.3%',
                    positive: true
                },
                {
                    icon: 'fa-car',
                    value: parkingUsage + '%',
                    label: 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ù',
                    color: '#43e97b',
                    colorLight: '#38f9d7',
                    change: '-3.5%',
                    positive: false
                },
                {
                    icon: 'fa-parking',
                    value: totalParking.toLocaleString('ar-SA'),
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ù',
                    color: '#fa709a',
                    colorLight: '#fee140',
                    change: '0%',
                    positive: true
                },
                {
                    icon: 'fa-percent',
                    value: '93%',
                    label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø´ØºØ§Ù„',
                    color: '#30cfd0',
                    colorLight: '#330867',
                    change: '+4.2%',
                    positive: true
                }
            ];

            const statsHTML = stats.map(stat => `
                <div class="stat-card" style="--card-color: ${stat.color}; --card-color-light: ${stat.colorLight}">
                    <div class="stat-icon" style="background: linear-gradient(135deg, ${stat.color}, ${stat.colorLight})">
                        <i class="fas ${stat.icon}"></i>
                    </div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-change ${stat.positive ? 'positive' : 'negative'}">
                        <i class="fas fa-arrow-${stat.positive ? 'up' : 'down'}"></i> ${stat.change}
                    </div>
                </div>
            `).join('');

            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        // Update charts
        function updateCharts() {
            // Buildings distribution chart
            const buildingCounts = {};
            allResidents.forEach(r => {
                const building = r.building || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                buildingCounts[building] = (buildingCounts[building] || 0) + 1;
            });

            const buildingLabels = Object.keys(buildingCounts).slice(0, 10);
            const buildingData = buildingLabels.map(b => buildingCounts[b]);

            if (charts.buildings) charts.buildings.destroy();
            charts.buildings = new Chart(document.getElementById('buildingsChart'), {
                type: 'pie',
                data: {
                    labels: buildingLabels,
                    datasets: [{
                        data: buildingData,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#fa709a', '#fee140'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Occupancy chart
            if (charts.occupancy) charts.occupancy.destroy();
            charts.occupancy = new Chart(document.getElementById('occupancyChart'), {
                type: 'bar',
                data: {
                    labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ'],
                    datasets: [{
                        label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø´ØºØ§Ù„ %',
                        data: [87, 89, 91, 88, 92, 93, 93],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Parking chart
            const parkingOccupied = allParking.filter(p => p.status === 'Ù…Ø´ØºÙˆÙ„' || p.status === 'occupied').length;
            const parkingAvailable = allParking.length - parkingOccupied;

            if (charts.parking) charts.parking.destroy();
            charts.parking = new Chart(document.getElementById('parkingChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ù…Ø´ØºÙˆÙ„', 'Ù…ØªØ§Ø­'],
                    datasets: [{
                        data: [parkingOccupied, parkingAvailable],
                        backgroundColor: ['#f5576c', '#43e97b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Stickers chart
            const activeStickers = allStickers.filter(s => s.status === 'ÙØ¹Ø§Ù„' || s.status === 'active').length;
            const inactiveStickers = allStickers.length - activeStickers;

            if (charts.stickers) charts.stickers.destroy();
            charts.stickers = new Chart(document.getElementById('stickersChart'), {
                type: 'line',
                data: {
                    labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ'],
                    datasets: [{
                        label: 'Ù…Ù„ØµÙ‚Ø§Øª Ù†Ø´Ø·Ø©',
                        data: [1850, 1920, 2050, 2100, 2150, 2180, activeStickers],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Switch between tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event?.target?.classList.add('active');
            
            // Update table based on tab
            switch(tabName) {
                case 'violations':
                    updateViolationsTable();
                    break;
                case 'stickers':
                    updateStickersTable();
                    break;
                case 'parking':
                    updateParkingTable();
                    break;
            }
        }

        // Update violations table (placeholder - no violations data yet)
        function updateViolationsTable(filteredData = null) {
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                <i class="fas fa-info-circle" style="font-size: 3em; margin-bottom: 15px; display: block;"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø§Ù„ÙØ§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // Update stickers table
        function updateStickersTable(filteredData = null) {
            const data = filteredData || allStickers.slice(0, 50);
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚ <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(1)">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(2)">Ø§Ù„Ø§Ø³Ù… <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(3)">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(4)">Ø§Ù„Ø­Ø§Ù„Ø© <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(sticker => `
                            <tr>
                                <td><i class="fas fa-id-card"></i> ${sticker.stickerNumber || sticker.sticker_number || '-'}</td>
                                <td><strong>${sticker.plateNumber || sticker.plate_number || '-'}</strong></td>
                                <td>${sticker.ownerName || sticker.owner_name || '-'}</td>
                                <td>${sticker.vehicleType || sticker.car_type || '-'}</td>
                                <td><span class="badge ${sticker.status === 'ÙØ¹Ø§Ù„' || sticker.status === 'active' ? 'active' : 'inactive'}">${sticker.status || '-'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 15px; color: #666; text-align: center;">
                    Ø¹Ø±Ø¶ ${data.length} Ù…Ù† Ø£ØµÙ„ ${allStickers.length} Ø³Ø¬Ù„
                </p>
            `;
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // Update parking table
        function updateParkingTable(filteredData = null) {
            const data = filteredData || allParking.slice(0, 50);
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ù <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(1)">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(2)">Ø§Ù„Ù…Ø¨Ù†Ù‰ <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(3)">Ø§Ù„Ù†ÙˆØ¹ <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(4)">Ø§Ù„Ø­Ø§Ù„Ø© <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(parking => `
                            <tr>
                                <td><i class="fas fa-parking"></i> ${parking.parkingNumber || parking.parking_number || parking.id || '-'}</td>
                                <td><strong>${parking.plateNumber || parking.plate_number || '-'}</strong></td>
                                <td>${parking.building || '-'}</td>
                                <td>${parking.type || '-'}</td>
                                <td><span class="badge ${parking.status === 'Ù…Ø´ØºÙˆÙ„' || parking.status === 'occupied' ? 'occupied' : 'active'}">${parking.status || '-'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 15px; color: #666; text-align: center;">
                    Ø¹Ø±Ø¶ ${data.length} Ù…Ù† Ø£ØµÙ„ ${allParking.length} Ø³Ø¬Ù„
                </p>
            `;
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();

            // Search box
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (currentTab === 'stickers') {
                        const filtered = allStickers.filter(s => 
                            (s.stickerNumber && s.stickerNumber.toString().toLowerCase().includes(searchTerm)) ||
                            (s.plateNumber && s.plateNumber.toLowerCase().includes(searchTerm)) ||
                            (s.ownerName && s.ownerName.toLowerCase().includes(searchTerm)) ||
                            (s.vehicleType && s.vehicleType.toLowerCase().includes(searchTerm))
                        );
                        updateStickersTable(filtered);
                    } else if (currentTab === 'parking') {
                        const filtered = allParking.filter(p => 
                            (p.parkingNumber && p.parkingNumber.toString().toLowerCase().includes(searchTerm)) ||
                            (p.plateNumber && p.plateNumber.toLowerCase().includes(searchTerm)) ||
                            (p.building && p.building.toLowerCase().includes(searchTerm)) ||
                            (p.type && p.type.toLowerCase().includes(searchTerm))
                        );
                        updateParkingTable(filtered);
                    }
                });
            }
        });

        // Sort table
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.querySelector('.data-table tbody');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                return sortDirection[columnIndex] 
                    ? aText.localeCompare(bText, 'ar')
                    : bText.localeCompare(aText, 'ar');
            });
            
            table.innerHTML = '';
            rows.forEach(row => table.appendChild(row));
        }

        // Export to Excel (CSV format)
        function exportToExcel() {
            let data = [];
            let filename = '';
            
            if (currentTab === 'violations') {
                filename = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª_Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©.csv';
                data = ['Ø±Ù‚Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©,Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©,Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø­Ø§Ù„Ø©'];
                // No violations data currently
                data.push('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
            } else if (currentTab === 'stickers') {
                filename = 'ØªÙ‚Ø±ÙŠØ±_Ù…Ù„ØµÙ‚Ø§Øª_Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª.csv';
                data = ['Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚,Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©,Ø§Ù„Ø§Ø³Ù…,Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©,Ø§Ù„Ø­Ø§Ù„Ø©'];
                allStickers.forEach(s => {
                    data.push(`${s.stickerNumber || '-'},${s.plateNumber || '-'},${s.ownerName || '-'},${s.vehicleType || '-'},${s.status || '-'}`);
                });
            } else if (currentTab === 'parking') {
                filename = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ÙˆØ§Ù‚Ù.csv';
                data = ['Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ù,Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©,Ø§Ù„Ù…Ø¨Ù†Ù‰,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„Ø­Ø§Ù„Ø©'];
                allParking.forEach(p => {
                    data.push(`${p.parkingNumber || p.parking_number || p.id || '-'},${p.plateNumber || p.plate_number || '-'},${p.building || '-'},${p.type || '-'},${p.status || '-'}`);
                });
            }
            
            const csvContent = '\ufeff' + data.join('\n'); // BOM for Arabic support
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Print table
        function printTable() {
            const printWindow = window.open('', '', 'height=600,width=800');
            const table = document.querySelector('.data-table');
            
            if (!table) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                return;
            }
            
            let title = '';
            if (currentTab === 'violations') title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©';
            else if (currentTab === 'stickers') title = 'ØªÙ‚Ø±ÙŠØ± Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª';
            else if (currentTab === 'parking') title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ù‚Ù';
            
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
                        body { padding: 20px; }
                        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
                        .info { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
                        th { background-color: #667eea; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 2px solid #ddd; padding-top: 10px; }
                        @media print {
                            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="info">
                        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒØ§Ù† - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</p>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                    ${table.outerHTML}
                    <div class="footer">
                        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Export to PDF (using print to PDF)
        function exportToPDF() {
            alert('Ù„ØªØµØ¯ÙŠØ± PDFØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø·Ø¨Ø§Ø¹Ø©" Ø«Ù… Ø§Ø®ØªØ± "Ø­ÙØ¸ ÙƒÙ€ PDF" Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª');
            printTable();
        }
    </script>
</body>
</html>

