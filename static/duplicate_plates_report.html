<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙˆØ§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tajawal:700,400&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            direction: rtl;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .main-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .filter-section input,
        .filter-section select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            font-weight: bold;
            font-size: 16px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .duplicate-badge {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .similar-badge {
            background: #ffc107;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .exact-badge {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .plate-display {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 8px;
            display: inline-block;
            min-width: 150px;
        }

        .highlight-duplicate {
            background: #ffe6e6 !important;
        }

        .highlight-similar {
            background: #fff8e6 !important;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 48px;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            body {
                background: white;
            }
            .back-btn, .action-buttons, .filter-section {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="main_portal.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
            <h1>
                <i class="fas fa-clone"></i>
                ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙˆØ§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©
            </h1>
            <p>ÙƒØ´Ù ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">ğŸ“Š</div>
                <div class="number" id="totalPlates">0</div>
                <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙˆØ­Ø§Øª</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ”´</div>
                <div class="number" id="exactDuplicates">0</div>
                <div class="label">Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸŸ¡</div>
                <div class="number" id="similarPlates">0</div>
                <div class="label">Ù…ØªØ´Ø§Ø¨Ù‡Ø©</div>
            </div>
            <div class="stat-card">
                <div class="icon">âœ…</div>
                <div class="number" id="uniquePlates">0</div>
                <div class="label">ÙØ±ÙŠØ¯Ø©</div>
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="main-card">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="scanForDuplicates()">
                    <i class="fas fa-search"></i>
                    ÙØ­Øµ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    ØªØµØ¯ÙŠØ± Excel
                </button>
                <button class="btn btn-info" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                <button class="btn btn-warning" onclick="generateDetailedReport()">
                    <i class="fas fa-file-alt"></i>
                    ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ
                </button>
            </div>

            <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
            <div class="filter-section">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label><i class="fas fa-filter"></i> Ù†ÙˆØ¹ Ø§Ù„ØªÙƒØ±Ø§Ø±:</label>
                        <select id="filterType" onchange="filterResults()">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                            <option value="exact">Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹</option>
                            <option value="similar">Ù…ØªØ´Ø§Ø¨Ù‡Ø©</option>
                        </select>
                    </div>
                    <div>
                        <label><i class="fas fa-search"></i> Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø§Øª:</label>
                        <input type="text" id="searchPlate" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø£Ø­Ø±Ù Ø§Ù„Ù„ÙˆØ­Ø©..." oninput="filterResults()">
                    </div>
                    <div>
                        <label><i class="fas fa-sort-amount-down"></i> Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙƒØ±Ø§Ø±:</label>
                        <input type="number" id="minOccurrences" value="2" min="2" onchange="filterResults()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div class="main-card">
            <h2><i class="fas fa-table"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ</h2>
            <div id="resultsContainer">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ÙØ­Øµ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                    <p>Ø³ÙŠØªÙ… ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ´Ø§Ø¨Ù‡Ø§Øª</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allResults = [];
        let filteredResults = [];

        async function scanForDuplicates() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù„ÙˆØ­Ø§Øª...</p></div>';

            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API
                const response = await fetch('/api/stickers');
                const data = await response.json();
                const stickers = data.data || [];

                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø§Øª
                const plateGroups = analyzePlates(stickers);
                allResults = plateGroups;
                filteredResults = [...allResults];

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                updateStatistics();
                displayResults();
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function analyzePlates(stickers) {
            const plateMap = new Map();
            const results = [];

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª
            stickers.forEach(sticker => {
                const plate = (sticker.plate_number || '').trim().toUpperCase();
                if (!plate || plate === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' || plate === 'NULL') return;

                if (!plateMap.has(plate)) {
                    plateMap.set(plate, []);
                }
                plateMap.get(plate).push(sticker);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ´Ø§Ø¨Ù‡Ø§Øª
            const plates = Array.from(plateMap.keys());
            
            plates.forEach((plate, i) => {
                const occurrences = plateMap.get(plate);
                
                // Ù„ÙˆØ­Ø§Øª Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹
                if (occurrences.length > 1) {
                    results.push({
                        type: 'exact',
                        plate: plate,
                        count: occurrences.length,
                        items: occurrences,
                        similarity: 100
                    });
                }

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„ÙˆØ­Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø©
                for (let j = i + 1; j < plates.length; j++) {
                    const otherPlate = plates[j];
                    const similarity = calculateSimilarity(plate, otherPlate);
                    
                    if (similarity >= 70 && similarity < 100) {
                        results.push({
                            type: 'similar',
                            plate: plate,
                            similarTo: otherPlate,
                            count: occurrences.length,
                            items: occurrences,
                            similarity: similarity
                        });
                    }
                }
            });

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©
            results.sort((a, b) => {
                if (a.type === 'exact' && b.type === 'similar') return -1;
                if (a.type === 'similar' && b.type === 'exact') return 1;
                return b.count - a.count;
            });

            return results;
        }

        function calculateSimilarity(plate1, plate2) {
            const p1 = plate1.replace(/\s/g, '');
            const p2 = plate2.replace(/\s/g, '');

            if (p1 === p2) return 100;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­Ø±Ù ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
            let matches = 0;
            const maxLen = Math.max(p1.length, p2.length);

            for (let i = 0; i < Math.min(p1.length, p2.length); i++) {
                if (p1[i] === p2[i]) matches++;
            }

            // ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© (O vs 0, I vs 1, etc.)
            const similar = checkSimilarCharacters(p1, p2);
            
            return Math.round(((matches + similar) / maxLen) * 100);
        }

        function checkSimilarCharacters(str1, str2) {
            const similarPairs = {
                'O': '0', '0': 'O',
                'I': '1', '1': 'I',
                'S': '5', '5': 'S',
                'B': '8', '8': 'B',
                'Z': '2', '2': 'Z'
            };

            let similarCount = 0;
            for (let i = 0; i < Math.min(str1.length, str2.length); i++) {
                if (similarPairs[str1[i]] === str2[i]) {
                    similarCount += 0.5;
                }
            }
            return similarCount;
        }

        function updateStatistics() {
            const exactDups = allResults.filter(r => r.type === 'exact').length;
            const similarPlates = allResults.filter(r => r.type === 'similar').length;
            const totalUnique = new Set(allResults.map(r => r.plate)).size;

            document.getElementById('totalPlates').textContent = allResults.length;
            document.getElementById('exactDuplicates').textContent = exactDups;
            document.getElementById('similarPlates').textContent = similarPlates;
            document.getElementById('uniquePlates').textContent = totalUnique;
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');

            if (filteredResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle" style="color: #28a745;"></i>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„ÙˆØ­Ø§Øª Ù…ÙƒØ±Ø±Ø© Ø£Ùˆ Ù…ØªØ´Ø§Ø¨Ù‡Ø©</h3>
                        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ÙØ±ÙŠØ¯Ø©</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡</th>
                                <th>Ù…ØªØ´Ø§Ø¨Ù‡ Ù…Ø¹</th>
                                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredResults.forEach((result, index) => {
                const badgeClass = result.type === 'exact' ? 'duplicate-badge' : 'similar-badge';
                const badgeText = result.type === 'exact' ? 'Ù…ÙƒØ±Ø±Ø©' : 'Ù…ØªØ´Ø§Ø¨Ù‡Ø©';
                const rowClass = result.type === 'exact' ? 'highlight-duplicate' : 'highlight-similar';

                html += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td><span class="plate-display">${result.plate}</span></td>
                        <td><span class="${badgeClass}">${badgeText}</span></td>
                        <td><strong>${result.count}</strong></td>
                        <td>${result.similarity}%</td>
                        <td>${result.similarTo || '-'}</td>
                        <td>
                            <button class="btn btn-info" style="font-size: 12px; padding: 5px 10px;" onclick="showDetails(${index})">
                                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function filterResults() {
            const filterType = document.getElementById('filterType').value;
            const searchText = document.getElementById('searchPlate').value.toUpperCase();
            const minOccurrences = parseInt(document.getElementById('minOccurrences').value);

            filteredResults = allResults.filter(result => {
                // ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
                if (filterType !== 'all' && result.type !== filterType) {
                    return false;
                }

                // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
                if (searchText && !result.plate.includes(searchText)) {
                    return false;
                }

                // ÙÙ„ØªØ± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
                if (result.count < minOccurrences) {
                    return false;
                }

                return true;
            });

            displayResults();
        }

        function showDetails(index) {
            const result = filteredResults[index];
            let details = `Ø§Ù„Ù„ÙˆØ­Ø©: ${result.plate}\n`;
            details += `Ø§Ù„Ù†ÙˆØ¹: ${result.type === 'exact' ? 'Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹' : 'Ù…ØªØ´Ø§Ø¨Ù‡Ø©'}\n`;
            details += `Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±: ${result.count}\n\n`;
            details += `Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
            
            result.items.forEach((item, i) => {
                details += `${i + 1}. Ø§Ù„Ù…Ø§Ù„Ùƒ: ${item.resident_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                details += `   Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${item.vehicle_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                details += `   ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${item.issue_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n`;
            });

            alert(details);
        }

        function exportToExcel() {
            if (filteredResults.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            let csv = 'Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©,Ø§Ù„Ù†ÙˆØ¹,Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±,Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡,Ù…ØªØ´Ø§Ø¨Ù‡ Ù…Ø¹\n';
            
            filteredResults.forEach(result => {
                csv += `"${result.plate}",`;
                csv += `"${result.type === 'exact' ? 'Ù…ÙƒØ±Ø±Ø©' : 'Ù…ØªØ´Ø§Ø¨Ù‡Ø©'}",`;
                csv += `${result.count},`;
                csv += `${result.similarity}%,`;
                csv += `"${result.similarTo || '-'}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù„ÙˆØ­Ø§Øª_Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function generateDetailedReport() {
            if (filteredResults.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±');
                return;
            }

            let report = '=== ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ - Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙˆØ§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© ===\n\n';
            report += `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleString('ar-SA')}\n`;
            report += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙØ­ÙˆØµØ©: ${allResults.length}\n`;
            report += `Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹: ${allResults.filter(r => r.type === 'exact').length}\n`;
            report += `Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©: ${allResults.filter(r => r.type === 'similar').length}\n\n`;
            report += '--- Ø§Ù„ØªÙØ§ØµÙŠÙ„ ---\n\n';

            filteredResults.forEach((result, index) => {
                report += `${index + 1}. Ø§Ù„Ù„ÙˆØ­Ø©: ${result.plate}\n`;
                report += `   Ø§Ù„Ù†ÙˆØ¹: ${result.type === 'exact' ? 'Ù…ÙƒØ±Ø±Ø© ØªÙ…Ø§Ù…Ø§Ù‹' : 'Ù…ØªØ´Ø§Ø¨Ù‡Ø©'}\n`;
                report += `   Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±: ${result.count}\n`;
                report += `   Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡: ${result.similarity}%\n`;
                if (result.similarTo) {
                    report += `   Ù…ØªØ´Ø§Ø¨Ù‡Ø© Ù…Ø¹: ${result.similarTo}\n`;
                }
                report += `   Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
                result.items.forEach((item, i) => {
                    report += `     ${i + 1}. ${item.resident_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${item.vehicle_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                });
                report += '\n';
            });

            report += '=== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ===';

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ØªÙ‚Ø±ÙŠØ±_ØªÙØµÙŠÙ„ÙŠ_Ø§Ù„Ù„ÙˆØ­Ø§Øª_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
        }
    </script>
</body>
</html>
